<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="什么是“惊群现象”（thundering herd） 引用自wiki  In computer science, the thundering herd problem occurs when a large number of processes waiting for an event are awoken when that event occurs, but only one proces">
<meta name="keywords" content="Nginx&#x2F;OpenResty,C&#x2F;C++">
<meta property="og:type" content="article">
<meta property="og:title" content="Thundering Herd(惊群现象，accept, epoll)">
<meta property="og:url" content="http://yoursite.com/2018/07/25/Thundering-herd/index.html">
<meta property="og:site_name" content="Stone&#39;s Lab">
<meta property="og:description" content="什么是“惊群现象”（thundering herd） 引用自wiki  In computer science, the thundering herd problem occurs when a large number of processes waiting for an event are awoken when that event occurs, but only one proces">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-10-17T11:37:32.645Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thundering Herd(惊群现象，accept, epoll)">
<meta name="twitter:description" content="什么是“惊群现象”（thundering herd） 引用自wiki  In computer science, the thundering herd problem occurs when a large number of processes waiting for an event are awoken when that event occurs, but only one proces">

<link rel="canonical" href="http://yoursite.com/2018/07/25/Thundering-herd/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Thundering Herd(惊群现象，accept, epoll) | Stone's Lab</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Stone's Lab</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/25/Thundering-herd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="stonecool">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stone's Lab">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Thundering Herd(惊群现象，accept, epoll)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-25 15:31:08" itemprop="dateCreated datePublished" datetime="2018-07-25T15:31:08+08:00">2018-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-17 19:37:32" itemprop="dateModified" datetime="2019-10-17T19:37:32+08:00">2019-10-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="什么是“惊群现象”（thundering-herd）"><a href="#什么是“惊群现象”（thundering-herd）" class="headerlink" title="什么是“惊群现象”（thundering herd）"></a>什么是“惊群现象”（thundering herd）</h3><p> 引用自wiki</p>
<blockquote>
<p>In computer science, the thundering herd problem occurs when a large number of processes waiting for an event are awoken when that event occurs, but only one process is able to proceed at a time. After the processes wake up, they all demand the resource and a decision must be made as to which process can continue. After the decision is made, the remaining processes are put back to sleep, only to all wake up again to request access to the resource.<br>This occurs repeatedly, until there are no more processes to be woken up. Because all the processes use system resources upon waking, it is more efficient if only one process is woken up at a time.<br>This may render the computer unusable, but it can also be used as a technique if there is no other way to decide which process should continue (for example when programming with semaphores).</p>
</blockquote>
<a id="more"></a>
<p>概括一下：<br>多个进程（或线程）监听同一个事件（或端口）。当事件发生时，所有监听进程都将被从sleep态唤醒，但事件只会被分配给一个进程，其他进程又将返回sleep态。这种多余的进程状态的切换是一种资源消耗。   </p>
<p>常见的惊群现象发生在 accept／epoll 方法处。</p>
<h3 id="accept-惊群"><a href="#accept-惊群" class="headerlink" title="accept 惊群"></a>accept 惊群</h3><h4 id="进程版"><a href="#进程版" class="headerlink" title="进程版"></a>进程版</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT 6666</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FORKNUM 5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock, <span class="keyword">new</span>, i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>, <span class="title">client</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == sock)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(PORT);</span><br><span class="line">    addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock, (struct sockaddr *)&amp;addr, <span class="keyword">sizeof</span>(addr)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock, BACKLOG) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"listen"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; FORKNUM; ++i)</span><br><span class="line">    &#123;   </span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">-1</span> == pid)</span><br><span class="line">        &#123;   </span><br><span class="line">            perror(<span class="string">"fork"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == pid)</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="keyword">new</span> = accept(sock, (struct sockaddr*)&amp;client, (<span class="keyword">socklen_t</span> *)&amp;size);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;   </span><br><span class="line">                perror(<span class="string">"accept"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">            &#125;   </span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"pid: %d\n"</span>, getpid());</span><br><span class="line">            close(<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>代码具体流程：</p>
<ol>
<li>父进程调用 socket 一系列操作，socket，bind，listen</li>
<li>父进程 fork 出多个子进程，子进程调用 accept 阻塞在 socket 处</li>
<li>子进程 accept 成功，返回新句柄，打印日志，直接 close 新句柄。</li>
</ol>
</li>
<li><p>测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 执行多次</span><br><span class="line">nc 127.0.0.1 6666</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试结果 每次只有一个进程打印日志，证明只有一个进程被唤醒。</p>
</li>
</ul>
<h4 id="线程版"><a href="#线程版" class="headerlink" title="线程版"></a>线程版</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;                                               </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;                                              </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;                                          </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;                                          </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;                                           </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;                                              </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;                                             </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT 6666                                                </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG 100                                              </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTHREADNUM 5                                             </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">pthread_fun</span><span class="params">(<span class="keyword">void</span> *ptr)</span>                                     </span></span><br><span class="line"><span class="function"></span>&#123;                                                                </span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">new</span>;                                                     </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span>                                   </span><br><span class="line">    <span class="keyword">size_t</span> size;                                                 </span><br><span class="line">    <span class="keyword">int</span> *sock = (<span class="keyword">int</span> *)ptr;                                      </span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> = accept(*sock, (struct sockaddr*)&amp;client, (<span class="keyword">socklen_t</span> *)&amp;size);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span> &lt; <span class="number">0</span>)                                                 </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"accept"</span>);                                        </span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);                                      </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread id: %lu\n"</span>, pthread_self());                  </span><br><span class="line">    close(<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ptr;                                                  </span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span>                                  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock, i;                                                 </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span>                                     </span><br><span class="line">    <span class="keyword">pthread_t</span> threads[PTHREADNUM];                               </span><br><span class="line"></span><br><span class="line">    sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);                      </span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == sock)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"socket"</span>);                                        </span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);                                      </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;                                   </span><br><span class="line">    addr.sin_port = htons(PORT);                                 </span><br><span class="line">    addr.sin_addr.s_addr = htonl(INADDR_ANY);                    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock, (struct sockaddr *)&amp;addr, <span class="keyword">sizeof</span>(addr)) &lt; <span class="number">0</span>)  </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"socket"</span>);                                        </span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);                                      </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock, BACKLOG) &lt; <span class="number">0</span>)                               </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"listen"</span>);                                        </span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);                                      </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PTHREADNUM; ++i)                             </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;threads[i], <span class="literal">NULL</span>, pthread_fun, (<span class="keyword">void</span>*)&amp;sock) &lt; <span class="number">0</span>)     </span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">"pthread_create"</span>);                            </span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);                                  </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;       </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PTHREADNUM; ++i )                            </span><br><span class="line">    &#123;                                                            </span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != pthread_join(threads[i], <span class="literal">NULL</span>))                 </span><br><span class="line">        &#123;                                                        </span><br><span class="line">            perror(<span class="string">"pthread_join"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);                                  </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;       </span><br><span class="line"></span><br><span class="line">    close(sock);                                                 </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;                                         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>流程大致与“进程版”相似，测试结果也一致，一个请求到来时，只有一个线程被唤醒</li>
</ul>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>每次请求都只有一个进程（线程）被唤醒， accept方法不存在“惊群问题”。<br>Linux内核已修复accept处的“惊群问题”。</p>
<h3 id="epoll-惊群"><a href="#epoll-惊群" class="headerlink" title="epoll 惊群"></a>epoll 惊群</h3><h4 id="进程版-1"><a href="#进程版-1" class="headerlink" title="进程版"></a>进程版</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT 6666</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROCESSNUM 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXEVENT 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock, <span class="keyword">new</span>, i, fd, ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>, <span class="title">client</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span> = &#123;</span><span class="number">0</span>&#125;, ee[MAXEVENT];</span><br><span class="line"></span><br><span class="line">    sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == sock)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(PORT);</span><br><span class="line">    addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock, (struct sockaddr *)&amp;addr, <span class="keyword">sizeof</span>(addr)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line"></span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock, BACKLOG) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"listen"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 sock 设置为非阻塞，这样程序不会阻塞在accept处，误被唤醒的进程会立即返回</span></span><br><span class="line">    <span class="keyword">if</span> (fcntl(sock, F_SETFL, O_NONBLOCK) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"fcntl"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    fd = epoll_create(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == fd)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"epoll_create"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    ev.events |= EPOLLIN;</span><br><span class="line">    ev.data.fd = sock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(fd, EPOLL_CTL_ADD, sock, &amp;ev) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"epoll_ctl"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PROCESSNUM; ++i)</span><br><span class="line">    &#123;   </span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">-1</span> == pid)</span><br><span class="line">        &#123;   </span><br><span class="line">            perror(<span class="string">"fork"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == pid)</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;   </span><br><span class="line">                ret = epoll_wait(fd, (struct epoll_event*)&amp;ee, MAXEVENT, <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ret; ++i)</span><br><span class="line">                &#123;   </span><br><span class="line">                    <span class="keyword">if</span> (ee[i].data.fd == sock)</span><br><span class="line">                    &#123;   </span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"epoll_wait: %d\n"</span>, getpid());</span><br><span class="line">                        sleep(<span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">new</span> = accept(sock, (struct sockaddr*)&amp;client, (<span class="keyword">socklen_t</span> *)&amp;size);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">new</span> &lt; <span class="number">0</span>)</span><br><span class="line">                        &#123;   </span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;   </span><br><span class="line"></span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"accept: %d\n"</span>, getpid());</span><br><span class="line">                        close(<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">goto</span> back;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">back:</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>代码具体流程</p>
<ol>
<li>父进程调用 socket 一系列操作，socket，bind，listen</li>
<li>父进程调用 epoll_create, epoll_ctl, 将需要监听端口加入 epoll 的句柄中</li>
<li>父进程 fork 出多个子进程，子进程调用 epoll_wait ，子进程阻塞</li>
<li>子进程从  epoll_wait 中返回，调用 accept。accept 成功，返回新句柄，打印日志，直接 close 新句柄。</li>
</ol>
</li>
<li><p>测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 执行多次</span><br><span class="line">nc 127.0.0.1 6666</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试结果：   </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">epoll_wait: 27849   </span><br><span class="line">epoll_wait: 27848</span><br><span class="line">epoll_wait: 27846</span><br><span class="line">epoll_wait: 27847</span><br><span class="line">epoll_wait: 27845</span><br><span class="line">accept: 27849</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">epoll_wait: 27847</span><br><span class="line">epoll_wait: 27845</span><br><span class="line">epoll_wait: 27846</span><br><span class="line">epoll_wait: 27848</span><br><span class="line">accept: 27847</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">epoll_wait: 27846</span><br><span class="line">epoll_wait: 27845</span><br><span class="line">epoll_wait: 27848</span><br><span class="line">accept: 27846</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">epoll_wait: 27845</span><br><span class="line">epoll_wait: 27848</span><br><span class="line">accept: 27845</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">epoll_wait: 27848</span><br><span class="line">accept: 27848</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析结果：<br>当一个请求到来，epoll_wait 在该 socket 的所有进程都被唤醒，但只有一个进程的 accept 能拿到新句柄，其他进程将继续阻塞在 accept。<br>（本例已将句柄设置为非阻塞状态，不会在accept处阻塞，即使拿不到新句柄，也会立即返回，并重新阻塞在 epoll_wait 处）</p>
</li>
<li><p>伪代码标示如何将误被唤醒的进程，重新返回 epoll_wait 处阻塞   </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将 sock 设置为非阻塞，这样程序不会阻塞在accept处，误被唤醒的进程会立即返回</span></span><br><span class="line"><span class="keyword">if</span> (fcntl(sock, F_SETFL, O_NONBLOCK) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;   </span><br><span class="line">    perror(<span class="string">"fcntl"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// accept 直接返回，</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    epoll_wait();</span><br><span class="line">    <span class="keyword">for</span> (...)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> = accept();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;   </span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="线程版-1"><a href="#线程版-1" class="headerlink" title="线程版"></a>线程版</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PORT 6666</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BACKLOG 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTHREADNUM 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXEVENT 1024</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> sock;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">pthread_fun</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">new</span>, ret, i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_struct</span> *<span class="title">pes</span> = (<span class="title">struct</span> <span class="title">epoll_struct</span>*)<span class="title">ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ee</span>[<span class="title">MAXEVENT</span>];</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        ret = epoll_wait(pes-&gt;fd, (struct epoll_event*)&amp;ee, MAXEVENT, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ret; ++i)</span><br><span class="line">        &#123;   </span><br><span class="line">            <span class="keyword">if</span> (ee[i].data.fd == pes-&gt;sock)</span><br><span class="line">            &#123;   </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"accept, thread id: %lu\n"</span>, pthread_self());</span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">new</span> = accept(pes-&gt;sock, (struct sockaddr*)&amp;client, (<span class="keyword">socklen_t</span> *)&amp;size);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">new</span> &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;   </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;   </span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"thread id: %lu\n"</span>, pthread_self());</span><br><span class="line">                close(<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">goto</span> back;</span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">back:</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock, i, fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> threads[PTHREADNUM];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_struct</span> <span class="title">es</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></span><br><span class="line"></span><br><span class="line">    sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == sock)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(PORT);</span><br><span class="line">    addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock, (struct sockaddr *)&amp;addr, <span class="keyword">sizeof</span>(addr)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock, BACKLOG) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"listen"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fcntl(sock, F_SETFL, O_NONBLOCK) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        perror(<span class="string">"fcntl"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    fd = epoll_create(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == fd)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"epoll_create"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ev.events |= EPOLLIN;</span><br><span class="line">    ev.data.fd = sock;</span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(fd, EPOLL_CTL_ADD, sock, &amp;ev) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"epoll_ctl"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    es.fd = fd;</span><br><span class="line">    es.sock = sock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PTHREADNUM; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_create(&amp;threads[i], <span class="literal">NULL</span>, pthread_fun, (<span class="keyword">void</span>*)&amp;es) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">"pthread_create"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PTHREADNUM; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != pthread_join(threads[i], <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">"pthread_join"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>流程大致与“进程版”一致</li>
<li>测试结果：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">accept, thread id: 139800247498496</span><br><span class="line">accept, thread id: 139800505693952</span><br><span class="line">accept, thread id: 139800763889408</span><br><span class="line">accept, thread id: 139801022084864</span><br><span class="line">accept, thread id: 139801280280320</span><br><span class="line">thread id: 139800247498496</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">accept, thread id: 139801280280320</span><br><span class="line">accept, thread id: 139801022084864</span><br><span class="line">accept, thread id: 139800763889408</span><br><span class="line">accept, thread id: 139800505693952</span><br><span class="line">thread id: 139801280280320</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">accept, thread id: 139800505693952</span><br><span class="line">accept, thread id: 139800763889408</span><br><span class="line">accept, thread id: 139801022084864</span><br><span class="line">thread id: 139800505693952</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">accept, thread id: 139801022084864</span><br><span class="line">accept, thread id: 139800763889408</span><br><span class="line">thread id: 139801022084864</span><br><span class="line"><span class="meta">#</span></span><br><span class="line">accept, thread id: 139800763889408</span><br><span class="line">thread id: 139800763889408</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h4><p>epoll_wait 方法处存在惊群现象，无论是在多进程还是在多线程的情况下。</p>
<h3 id="Reference-amp-Thanks"><a href="#Reference-amp-Thanks" class="headerlink" title="Reference &amp; Thanks"></a>Reference &amp; Thanks</h3><ul>
<li><a href="https://en.wikipedia.org/wiki/Thundering_herd_problem" target="_blank" rel="noopener">Thundering herd problem</a></li>
<li><a href="https://pureage.info/2015/12/22/thundering-herd.html" target="_blank" rel="noopener">accept与epoll惊群</a></li>
<li><a href="https://blog.csdn.net/russell_tao/article/details/7204260" target="_blank" rel="noopener">“惊群”，看看nginx是怎么解决它的</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Nginx-OpenResty/" rel="tag"># Nginx/OpenResty</a>
              <a href="/tags/C-C/" rel="tag"># C/C++</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/07/20/regex-sed/" rel="prev" title="正则表达式中关于 [] 的用法">
      <i class="fa fa-chevron-left"></i> 正则表达式中关于 [] 的用法
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/07/27/process-vs-threads/" rel="next" title="Process vs Threads(进程和多线程内存分配)">
      Process vs Threads(进程和多线程内存分配) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是“惊群现象”（thundering-herd）"><span class="nav-number">1.</span> <span class="nav-text">什么是“惊群现象”（thundering herd）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#accept-惊群"><span class="nav-number">2.</span> <span class="nav-text">accept 惊群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#进程版"><span class="nav-number">2.1.</span> <span class="nav-text">进程版</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程版"><span class="nav-number">2.2.</span> <span class="nav-text">线程版</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结论"><span class="nav-number">2.3.</span> <span class="nav-text">结论</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#epoll-惊群"><span class="nav-number">3.</span> <span class="nav-text">epoll 惊群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#进程版-1"><span class="nav-number">3.1.</span> <span class="nav-text">进程版</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程版-1"><span class="nav-number">3.2.</span> <span class="nav-text">线程版</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结论-1"><span class="nav-number">3.3.</span> <span class="nav-text">结论</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference-amp-Thanks"><span class="nav-number">4.</span> <span class="nav-text">Reference &amp; Thanks</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">stonecool</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/stonecool" title="GitHub → https://github.com/stonecool" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/34523tgwerrq3" title="Weibo → https://weibo.com/34523tgwerrq3" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://coolshell.cn/" title="https://coolshell.cn/" rel="noopener" target="_blank">CoolShell</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://openresty.com/" title="http://openresty.com/" rel="noopener" target="_blank">OpenResty</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://smartisan.com/" title="https://smartisan.com/" rel="noopener" target="_blank">Smartisan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://nanjinglizhi.cn/" title="http://nanjinglizhi.cn/" rel="noopener" target="_blank">NanJingLizhi</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">stonecool</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
